USE Backshop_DEV
GO


DECLARE @LoanMaster TABLE (CONTROLID NVARCHAR (7), LOANNUMBER BIGINT, PROPTYPE NVARCHAR (3), EFFDATE DATE)

INSERT INTO @LoanMaster
	SELECT a.ControlId, c.ServicerLoanNUmber, e.PropertyTypeMajorCd_F AS [PROP_TYPE], MAX(d.DATA_EFFDATE) FROM dbo.tblControlMaster a 
		INNER JOIN tblNote b ON a.ControlId = b.ControlId_F
		INNER JOIN tblNoteExp c ON c.NoteId_F = b.NoteId
		INNER JOIN tblProperty e ON e.ControlId_F = a.ControlId
		LEFT JOIN HSB_HIST.STRATEGY_EXTRACT d ON d.[LOANNBR] = c.ServicerLoanNumber
		GROUP BY a.ControlId, c.ServicerLoanNUmber, e.PropertyTypeMajorCd_F
		ORDER BY a.ControlId, CONVERT(BIGINT, ServicerLoanNUmber)


UPDATE tblControlMaster SET LoanStatusCd_F = 'F', AuditUpdateDate = GETDATE(), AuditUpdateUserId = 'SYSTEM' WHERE ControlId IN (SELECT CONTROLID FROM @LoanMaster WHERE EFFDATE IS NULL  GROUP BY PROPTYPE)

UPDATE tblControlMasterDealPhaseTemplateItem SET 
	CompletedDate = GETDATE(), SkippedSw = 1, AuditUpdateUserId = 'SYSTEM', AuditUpdateDate = GETDATE()
	WHERE ControlId_F = '' AND CompletedDate IS NULL AND WorkflowTemplateTypeCd_F = 'HCC'

INSERT INTO tblAssetManagementStatusLog (ControlId_F, AssetManagementStatusCd_F, StatusStartDate, StatusEndDate, StatusLogUserFullName, AuditAddUserId, StatusUpdateDate, TroubledDebtRestructure) VALUES 
	(, 'SALE', GETDATE(), '2999-12-31 23:59:59.000', 'SYSTEM', 'SYSTEM', GETDATE(), 0)


-- -- To get list of loans originated by Brea and their last payment date to assess if they're still on HMST books
--USE CRE_ODS
--GO
--SELECT DISTINCT LOANNBR, MAX(DATA_EFFDATE) OVER (PARTITION BY LOANNBR) AS [LAST_UPDATED_DATE] FROM HSB_HIST.STRATEGY_EXTRACT WHERE LOANNBR BETWEEN 600000000 AND 700000000 
--	ORDER BY LAST_UPDATED_DATE


SELECT ServicerLoanNumber, ControlId_F FROM tblNoteExp 
INNER JOIN tblNote ON NoteId = NoteId_F
WHERE ServicerLoanNumber IN (
600100105,
600100108,
600100118,
600100145,
600100154,
600100203,
600100253,
600100254,
600100261,
600100268,
600100274,
600100275,
600100276,
600100288,
600100292,
600100311,
600100318,
600100340,
600100344,
600100357,
600100358,
600100359,
600100361,
600100366,
600100408,
600100417,
600100426,
600100432,
600100445,
600100446,
600100464,
600100465,
600100466,
600100475,
600100503,
600100523,
600100535,
600100551,
600100554,
600100555,
600100561,
600100569,
600100577,
600100590,
600100591,
600100597,
600100599,
600100600,
600100604,
600100607,
600100620,
600100623,
600100632,
600100650,
600100660,
600100684,
600100685,
600100693,
600100695,
600100696,
600100697,
600100703,
600100704,
600100705,
600100718,
600100723,
600100725,
600100742,
600100747,
600100755,
600100762,
600100767,
600100768,
600100769,
600100789,
600100792,
600100793,
600100794,
600100806,
600100808,
600100829,
600100831,
600100834,
600100836,
600100837,
600100838,
600100839,
600100861,
600100863,
600100868,
600100877,
600100878,
600100888,
600100897,
600100904,
600100905,
600100960,
600100966,
600100971,
600100974,
600100982,
600100983,
600100984,
600100996,
600101007,
600101026,
600101034,
600101038,
600101039,
600101042,
600101043,
600101053,
600101054,
600101058,
600101060,
600101061,
600101062,
600101070,
600101071,
600101072,
600101073,
600101075,
600101076,
600101082,
600101083,
600101084,
600101093,
600101097,
600101101,
600101102,
600101103,
600101104,
600101105,
600101113,
600101122,
600101123,
600101126,
600101127,
600101131,
600101132,
600101133,
600101134,
600101135,
600101142,
600101150,
600101151,
600101156,
600101159,
600101179,
600101183,
600101186,
600101187,
600101198,
600101199,
600101203,
600101206,
600101214,
600101215,
600101224,
600101229,
600101238,
600101242,
600101243,
600101244,
600101246,
600101250,
600101251,
600101284,
600101295,
600101305,
600101338,
600101339,
600101354,
600101359,
600101362,
600101365,
600101369,
600101370,
600101376,
600101380,
600101381,
600101383,
600101385,
600101389,
600101399,
600101406,
600101412,
600101413,
600101414,
600101434,
600101440,
600101441,
600101442,
600101451,
600101454,
600101456,
600101462,
600101463,
600101464,
600101465,
600101468,
600101470,
600101475,
600101481,
600101484,
600101485,
600101492,
600101497,
600101498,
600101499,
600101505,
600101506,
600101508,
600101509,
600101512,
600101513,
600101514,
600101516,
600101517,
600101518,
600101519,
600101528,
600101534,
600101535,
600101541,
600101542,
600101543,
600101546,
600101547,
600101551,
600101555,
600101558,
600101559,
600101560,
600101561,
600101562,
600101563,
600101570,
600101571,
600101573,
600101578,
600101580,
600101581,
600101585,
600101593,
600101598,
600101599,
600101607,
600101608,
600101611,
600101613,
600101614,
600101619,
600101620,
600101626,
600101630,
600101633,
600101634,
600101636,
600101641,
600101642,
600101643,
600101644,
600101645,
600101646,
600101652,
600101657,
600101658,
600101660,
600101661,
600101662,
600101664,
600101665,
600101669,
600101670,
600101672,
600101674,
600101676,
600101684,
600101688,
600101691,
600101692,
600101695,
600101696,
600101698,
600101705,
600101706,
600101710,
600101724,
600101725,
600101731,
600101732,
600101736,
600101746,
600101748,
600101754,
600101755,
600101759,
600101760,
600101762,
600101763,
600101768,
600101781,
600101782,
600101783,
600101796,
600101814,
600101817,
600101818,
600101820,
600101821,
600101822,
600101828,
600101835,
600101841,
600101842,
600101843,
600101844,
600101848,
600101849,
600101851,
600101859,
600101860,
600101861,
600101866,
600101867,
600101868,
600101869,
600101870,
600101872,
600101874,
600101875,
600101876,
600101886,
600101887,
600101896,
600101897,
600101904,
600101907,
600101908,
600101909,
600101911,
600101913,
600101914,
600101918,
600101920,
600101924,
600101927,
600101929,
600101930,
600101933,
600101935,
600101940,
600101943,
600101949,
600101957,
600101958,
600101960,
600101962,
600101964,
600101965,
600101966,
600101968,
600101970,
600101972,
600101974,
600101976,
600101977,
600101984,
600101987,
600102001,
600102002,
600102016,
600102017,
600102020,
600102023,
600102038,
600102043,
600102051,
600102074
)